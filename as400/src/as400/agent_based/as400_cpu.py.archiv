#!/usr/bin/python
"""
AS 400 Checks
Bastian Kuhn, bastian.kuhn@kuhn-ruess.de
https://kuhn-ruess.de Checkmk Consulting and Development

"""

import time
from .lib import DETECT_AS400
from cmk.plugins.lib.cpu_util import check_cpu_util


from cmk.agent_based.v2 import (
        SimpleSNMPSection,
        CheckPlugin,
        Service,
        SNMPTree,
        State,
        Metric,
        Result,
        get_value_store,
)


def parse_as400_cpu(string_table):
    """ Parse Function """
    return int(string_table[0][0])

snmp_section_as400_cpu = SimpleSNMPSection(
    name="as400_cpu",
    detect=DETECT_AS400,
    fetch=SNMPTree(
        base=".1.3.6.1.4.1.2.6.4.5.1",
        oids=["0"],
    ),
    parse_function = parse_as400_cpu,
)
def discover_as400_cpu(section):
    """ Discover Function """
    yield Service()

def check_as400_cpu(params, section):
    """ Check Function """
    pct_usage = float(section) / 100.00
    yield from  check_cpu_util(util=pct_usage,
                               params=params,
                               value_store=get_value_store(),
                               this_time=time.time())

check_plugin_as400_users = CheckPlugin(
    name="as400_cpu",
    service_name="Users",
    discovery_function=discover_as400_cpu,
    check_function=check_as400_cpu,
    check_default_parameters={"levels": (80.0, 90.0), 'average': 15},
    check_ruleset_name="cpu_util",
)
